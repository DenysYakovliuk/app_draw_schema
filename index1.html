<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>App_draw_graph</title>
</head>
<body>
  <script src="node_modules/drawflow/dist/drawflow.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/js/all.min.js" integrity="sha256-KzZiKy0DWYsnwMF+X1DvQngQ2/FxF7MF3Ff72XcpuPs=" crossorigin="anonymous"></script>
  <link rel="stylesheet" type="text/css" href="drawflow.css" />
  <link rel="stylesheet" type="text/css" href="styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css" integrity="sha256-h20CPZ0QyXlBuAw7A+KluUYx/3pK+c7lYEpqLTlxjYQ=" crossorigin="anonymous" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
  <script src="https://unpkg.com/micromodal/dist/micromodal.min.js"></script>

  <header>
    <h2>–°—Ö–µ–º–∞ –≤–∑–∞—î–º–æ–∑–≤'—è–∑–∫—ñ–≤ –¥–∏—Å—Ü–∏–ø–ª—ñ–Ω</h2>
  </header>
  
  <div class="wrapper">
    <div class="col">
      <div class="sidebar-info">
        <div class="sidebar-header" onclick="toggleSidebarInfo()">
          <span>‚ÑπÔ∏è –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è (–Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è/–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è)</span>
        </div>
        <div id="sidebarContent" class="sidebar-content collapsed">
          <h3>–í—ñ—Ç–∞–Ω–Ω—è!!</h3>
          <p>–¶–µ–π –ø—Ä–æ–µ–∫—Ç –∑—Ä–æ–±–ª–µ–Ω–æ –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ <b>Drawflow</b>.</p>
          <br>
          <p><b><u>Shortkeys:</u></b></p>
          <p><b>Delete</b> ‚Äî –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è</p>
          <p><b>–õ–ö–ú</b> ‚Äî –¥–ª—è —Ä—É—Ö—É</p>
          <p><b>–ü–ö–ú</b> ‚Äî –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è</p>
          <p><b>Ctrl + –ö–æ–ª–µ—Å–æ –º–∏—à—ñ</b> ‚Äî –¥–ª—è –∑–±—ñ–ª—å—à–µ–Ω–Ω—è</p>
          <p><b>–ö–Ω–æ–ø–∫–∞ —ñ–∑ üîí</b> ‚Äî –¥–ª—è –∑–∞–∫—Ä—ñ–ø–ª–µ–Ω–Ω—è –µ–ª–µ–º–µ–Ω—Ç—ñ–≤</p>
        </div>
      </div>
      <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="simpleNode">
        <i class="simpleNode"></i><span>–ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å, —â–æ–± –¥–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π –±–ª–æ–∫ </span>
      </div>
      <button onclick="createNewSchema()" class="btn-new-schema">–°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤—É —Å—Ö–µ–º—É</button>
      <div id="schema-buttons"></div>
    </div>
    
    <div class="col-right">
      <div class="menu">
        <input type="text" class="title-input" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É —Å—Ö–µ–º–∏">
      </div>
      <div id="drawflow" ondrop="drop(event)" ondragover="allowDrop(event)">
        <div class="btn-export" onclick="exportJSON()">Export</div>
        <input type="file" id="importFile" style="display:none" onchange="importJSON(event)">
        <div class="btn-import" onclick="document.getElementById('importFile').click()">Import</div>
        <div class="btn-clear">Clear</div>
        <div class="btn-lock">
          <i id="lock" class="fas fa-lock" onclick="editor.editor_mode='fixed'; changeMode('lock');"></i>
          <i id="unlock" class="fas fa-lock-open" onclick="editor.editor_mode='edit'; changeMode('unlock');" style="display:none;"></i>
        </div>
        <div class="bar-zoom">
          <i class="fas fa-search-minus" onclick="editor.zoom_out()"></i>
          <i class="fas fa-search" onclick="editor.zoom_reset()"></i>
          <i class="fas fa-search-plus" onclick="editor.zoom_in()"></i>
        </div>
      </div>
    </div>
  </div>

  <svg width="0" height="0">
    <defs>
      <marker id="arrowhead" markerWidth="10" markerHeight="7" 
        refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="#4ea9ff"/>
      </marker>
    </defs>
  </svg>
  
  <script>

    var id = document.getElementById("drawflow");
    const editor = new Drawflow(id);
    editor.reroute = true;
    editor.reroute_fix_curvature = true;
    editor.force_first_input = false;

  
    editor.createCurvature = function(start_pos_x, start_pos_y, end_pos_x, end_pos_y, curvature_value, type) {
  const hx1 = start_pos_x + Math.abs(end_pos_x - start_pos_x) * curvature_value;
  const hx2 = end_pos_x - Math.abs(end_pos_x - start_pos_x) * curvature_value;

  return `M ${start_pos_x} ${start_pos_y} C ${hx1} ${start_pos_y}, ${hx2} ${end_pos_y}, ${end_pos_x} ${end_pos_y}`;
}

editor.curvature = 0.35;

    function toggleSidebarInfo() {
    const content = document.getElementById('sidebarContent');
    content.classList.toggle('expanded');
    }

    // Events!
    editor.on('nodeCreated', function(id) {
      console.log("Node created " + id);
    })

    editor.on('nodeRemoved', function(id) {
      console.log("Node removed " + id);
    })

    editor.on('nodeSelected', function(id) {
      console.log("Node selected " + id);
    })

    editor.on('moduleCreated', function(name) {
      console.log("Module Created " + name);
    })

    editor.on('moduleChanged', function(name) {
      console.log("Module Changed " + name);
    })

    editor.on('connectionCreated', function(connection) {
      console.log('Connection created');
      console.log(connection);
    })

    editor.on('connectionRemoved', function(connection) {
      console.log('Connection removed');
      console.log(connection);
    })

    editor.on('nodeMoved', function(id) {
      console.log("Node moved " + id);
    })

    editor.on('zoom', function(zoom) {
      console.log('Zoom level ' + zoom);
    })

    editor.on('translate', function(position) {
      console.log('Translate x:' + position.x + ' y:'+ position.y);
    })

    editor.on('addReroute', function(id) {
      console.log("Reroute added " + id);
    })

    editor.on('removeReroute', function(id) {
      console.log("Reroute removed " + id);
    })
    /* DRAG EVENT */

    /* Mouse and Touch Actions */

    var elements = document.getElementsByClassName('drag-drawflow');
    for (var i = 0; i < elements.length; i++) {
      elements[i].addEventListener('touchend', drop, false);
      elements[i].addEventListener('touchmove', positionMobile, false);
      elements[i].addEventListener('touchstart', drag, false );
    }

    var mobile_item_selec = '';
    var mobile_last_move = null;
   function positionMobile(ev) {
     mobile_last_move = ev;
   }

   function allowDrop(ev) {
      ev.preventDefault();
    }

    function drag(ev) {
      if (ev.type === "touchstart") {
        mobile_item_selec = ev.target.closest(".drag-drawflow").getAttribute('data-node');
      } else {
      ev.dataTransfer.setData("node", ev.target.getAttribute('data-node'));
      }
    }

    function drop(ev) {
      if (ev.type === "touchend") {
        var parentdrawflow = document.elementFromPoint( mobile_last_move.touches[0].clientX, mobile_last_move.touches[0].clientY).closest("#drawflow");
        if(parentdrawflow != null) {
          addNodeToDrawFlow(mobile_item_selec, mobile_last_move.touches[0].clientX, mobile_last_move.touches[0].clientY);
        }
        mobile_item_selec = '';
      } else {
        ev.preventDefault();
        var data = ev.dataTransfer.getData("node");
        addNodeToDrawFlow(data, ev.clientX, ev.clientY);
      }
    }

    function autoResizeTextarea(textarea) {
    textarea.style.height = "auto"; // –°–ø–æ—á–∞—Ç–∫—É —Å–∫–∏–¥–∞—î–º–æ –≤–∏—Å–æ—Ç—É
    textarea.style.height = textarea.scrollHeight + "px"; // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –Ω–æ–≤—É –≤–∏—Å–æ—Ç—É –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É
}

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –≤—É–∑–ª–∞
function addNodeToDrawFlow(name, pos_x, pos_y) {
    if (editor.editor_mode === 'fixed') {
        return false;
    }

    pos_x = (pos_x - editor.precanvas.getBoundingClientRect().x) / editor.zoom;
    pos_y = (pos_y - editor.precanvas.getBoundingClientRect().y) / editor.zoom;

    let nodeId = null;

    switch (name) {
      case 'simpleNode':
    nodeId = editor.addNode(
        'simple',
        1,
        1,
        pos_x,
        pos_y,
        'simple',
        { "text": "–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –¥–∏—Å—Ü–∏–ø–ª—ñ–Ω–∏" },
        `<div>
            <div class="title-box">
                <textarea df-name placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –¥–∏—Å—Ü–∏–ø–ª—ñ–Ω–∏"></textarea>
            </div>
        </div>`
    );

    // –°—Ç–≤–æ—Ä—é—î–º–æ MutationObserver –¥–ª—è –≤—ñ–¥—Å–ª—ñ–¥–∫–æ–≤—É–≤–∞–Ω–Ω—è –ø–æ—è–≤–∏ textarea
    const observer = new MutationObserver(() => {
                let textarea = document.querySelector(`#node-${nodeId} textarea[df-name]`);
                if (textarea) {
                    textarea.addEventListener("input", function () {
                        updateNodeTitle(`node-${nodeId}`, this.value);
                        autoResizeTextarea(this); // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–º—ñ–Ω–µ–Ω–Ω—è –≤–∏—Å–æ—Ç–∏
                    });

                    autoResizeTextarea(textarea); // –í–∏–∫–ª–∏–∫–∞—î–º–æ –ø—Ä–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
                    observer.disconnect(); // –í—ñ–¥–∫–ª—é—á–∞—î–º–æ —Å–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—á –ø—ñ—Å–ª—è –∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è textarea
                }
            });

            // –ó–∞–ø—É—Å–∫–∞—î–º–æ —Å–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—á –∑–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è–º –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ —É DOM
            observer.observe(document.body, {
                childList: true, 
                subtree: true
            });
    break;
        default:
            console.warn("–ù–µ–≤—ñ–¥–æ–º–∏–π —Ç–∏–ø –≤—É–∑–ª–∞:", name);
            return false;
    }
    saveDiagram();
    autoUpdateSchema();
}

let drawflowEditor = null;
let currentSchemaId = null;

window.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById("drawflow");
    drawflowEditor = new Drawflow(container);
    drawflowEditor.start();

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø—Ä–∏ –∑–º—ñ–Ω–∞—Ö
    drawflowEditor.on('nodeCreated', autoUpdateSchema);
    drawflowEditor.on('nodeRemoved', autoUpdateSchema);
    drawflowEditor.on('connectionCreated', autoUpdateSchema);
    drawflowEditor.on('connectionRemoved', autoUpdateSchema);
    drawflowEditor.on('nodeMoved', autoUpdateSchema);

    // –ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø—Ä–∏ –∑–º—ñ–Ω—ñ –Ω–∞–∑–≤–∏
    document.querySelector('.title-input').addEventListener('input', () => {
        autoUpdateSchema();
    });

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏ –∑–∞–ø—É—Å–∫—É
    loadSchemaButtons();

    // –ü—Ä–∏–≤‚Äô—è–∑–∫–∞ –∫–Ω–æ–ø–∫–∏ "Clear"
    const clearBtn = document.querySelector('.btn-clear');
    if (clearBtn) {
        clearBtn.addEventListener('click', () => {
            deleteCurrentSchema();
        });
    }
});

function updateNodeTitle(nodeId, newText) {
    let cleanNodeId = nodeId.replace("node-", "");
    let savedTitles = JSON.parse(localStorage.getItem("nodeTitles")) || {};
    savedTitles[nodeId] = newText;
    localStorage.setItem("nodeTitles", JSON.stringify(savedTitles));

    if (editor.drawflow?.drawflow?.Home?.data?.[cleanNodeId]) {
        editor.drawflow.drawflow.Home.data[cleanNodeId].data.text = newText;
    }
    saveDiagram();
}
    
  var transform = '';
  function showpopup(e) {
    e.target.closest(".drawflow-node").style.zIndex = "9999";
    e.target.children[0].style.display = "block";
    //document.getElementById("modalfix").style.display = "block";

    //e.target.children[0].style.transform = 'translate('+translate.x+'px, '+translate.y+'px)';
    transform = editor.precanvas.style.transform;
    editor.precanvas.style.transform = '';
    editor.precanvas.style.left = editor.canvas_x +'px';
    editor.precanvas.style.top = editor.canvas_y +'px';
    console.log(transform);

    //e.target.children[0].style.top  =  -editor.canvas_y - editor.container.offsetTop +'px';
    //e.target.children[0].style.left  =  -editor.canvas_x  - editor.container.offsetLeft +'px';
    editor.editor_mode = "fixed";

  }

   function closemodal(e) {
     e.target.closest(".drawflow-node").style.zIndex = "2";
     e.target.parentElement.parentElement.style.display  ="none";
     //document.getElementById("modalfix").style.display = "none";
     editor.precanvas.style.transform = transform;
       editor.precanvas.style.left = '0px';
       editor.precanvas.style.top = '0px';
      editor.editor_mode = "edit";
   }

    function changeModule(event) {
      var all = document.querySelectorAll(".menu ul li");
        for (var i = 0; i < all.length; i++) {
          all[i].classList.remove('selected');
        }
      event.target.classList.add('selected');
    }

    function changeMode(option) {

    //console.log(lock.id);
      if(option == 'lock') {
        lock.style.display = 'none';
        unlock.style.display = 'block';
      } else {
        lock.style.display = 'block';
        unlock.style.display = 'none';
      }
    }

//–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø—ñ—Å–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏

// –§—É–Ω–∫—Ü—ñ—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å—Ö–µ–º–∏ –≤ localStorage
function saveDiagram() {
    const data = JSON.stringify(editor.export());
    localStorage.setItem("drawflowData", data);
}

window.onload = function () {
    editor.start();

    const savedTitle = localStorage.getItem("schemaTitle");
    if (savedTitle) {
        document.querySelector(".title-input").value = savedTitle;
    }

    setTimeout(() => {
        loadDiagram();
        loadNodeTitles();
        initializeAllTextareas(); // üí° –û–¥–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è ‚Äî —É—Å–µ –Ω–∞–ª–∞—à—Ç–æ–≤—É—î
    }, 300);
};

// –í–∏–∫–ª–∏–∫–∞—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø—Ä–∏ –±—É–¥—å-—è–∫—ñ–π –∑–º—ñ–Ω—ñ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä—ñ
["nodeCreated", "nodeRemoved", "nodeMoved", "connectionCreated", "connectionRemoved"].forEach(event => {
    editor.on(event, saveDiagram);
});

console.log("–ó–±–µ—Ä–µ–∂–µ–Ω—ñ –¥–∞–Ω—ñ:", localStorage.getItem("drawflowData"));
console.log("–ß–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä?", editor);

editor.mode = "full";

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ö–µ–º–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
function loadDiagram() {
    let savedData = localStorage.getItem("drawflowData");
    if (savedData) {
        try {
            const parsedData = JSON.parse(savedData);
            editor.clear();
            editor.import(parsedData);

            // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –Ω–∞–∑–≤–∏ –≤—É–∑–ª—ñ–≤ —É –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ –ø–æ–ª—è –≤–≤–æ–¥—É
            let storedTitles = JSON.parse(localStorage.getItem("nodeTitles")) || {};
            for (let key in storedTitles) {
                let cleanNodeId = key.replace("node-", "");
                let nodeInput = document.querySelector(`#${key} input[df-name]`);
                
                if (nodeInput) {
                    nodeInput.value = storedTitles[key];
                }
                if (editor.drawflow.drawflow.Home.data[cleanNodeId]) {
                    editor.drawflow.drawflow.Home.data[cleanNodeId].data.text = storedTitles[key];
                }
            }
        } catch (error) {
            console.error("–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É —Å—Ö–µ–º–∏:", error);
        }
    }
}

function saveState() {
    if (!editor) return;

    const blocks = Array.from(document.querySelectorAll('.block')).map(block => ({
        id: block.id,
        x: block.offsetLeft,
        y: block.offsetTop
    }));

    const connections = Array.from(document.querySelectorAll('.connection')).map(conn => ({
        from: conn.dataset.from,
        to: conn.dataset.to
    }));

    localStorage.setItem('blocks', JSON.stringify(blocks));
    localStorage.setItem('connections', JSON.stringify(connections));
}

function loadState() {
    const blocksData = JSON.parse(localStorage.getItem('blocks')) || [];
    const connectionsData = JSON.parse(localStorage.getItem('connections')) || [];

    blocksData.forEach(data => {
        const block = document.createElement('div');
        block.classList.add('block');
        block.id = data.id;
        block.style.left = `${data.x}px`;
        block.style.top = `${data.y}px`;
        document.body.appendChild(block);
    });

    if (typeof drawConnection === "function") {
        connectionsData.forEach(conn => drawConnection(conn.from, conn.to));
    } else {
        console.warn("–§—É–Ω–∫—Ü—ñ—è drawConnection –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞!");
    }
}

// –í–∏–∫–ª–∏–∫–∞—î–º–æ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞–Ω—É –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏
window.addEventListener('DOMContentLoaded', loadState);

document.addEventListener('mouseup', saveState);  // –ó–±–µ—Ä—ñ–≥–∞—î —Å—Ç–∞–Ω –ø—ñ—Å–ª—è –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è –±–ª–æ–∫—ñ–≤


// //–ù–∞–∑–≤–∏ –ø—Ä–µ–¥–º–µ—Ç—ñ–≤

// –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å—Ö–µ–º–∏
document.querySelector(".title-input").addEventListener("input", function () {
    localStorage.setItem("schemaTitle", this.value);
});

document.addEventListener("input", function (event) {
    if (event.target.matches('.drawflow-node input[df-name]')) { 
        let nodeElement = event.target.closest(".drawflow-node");
        if (!nodeElement) return;

        let nodeId = nodeElement.id; 
        let newText = event.target.value;

        // –û–Ω–æ–≤–ª—é—î–º–æ localStorage
        let savedTitles = JSON.parse(localStorage.getItem("nodeTitles")) || {};
        savedTitles[nodeId] = newText;
        localStorage.setItem("nodeTitles", JSON.stringify(savedTitles));

        // –û–Ω–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ —É Drawflow
        let cleanNodeId = nodeId.replace("node-", ""); 
        if (editor.drawflow.drawflow.Home.data[cleanNodeId]) {
            editor.drawflow.drawflow.Home.data[cleanNodeId].data.text = newText;
        }
        autoResizeTextarea(event.target);
    }
});

function loadNodeTitles() {
    console.log("–î–∞–Ω—ñ —É localStorage:", localStorage.getItem("nodeTitles"));
    let storedTitles = JSON.parse(localStorage.getItem("nodeTitles")) || {};
    
    for (let key in storedTitles) {
        let nodeElement = document.querySelector(`#${key} textarea[df-name]`); 
        
        if (nodeElement) {
            nodeElement.value = storedTitles[key]; 
        }

        let cleanNodeId = key.replace("node-", ""); 
        if (editor.drawflow.drawflow.Home.data[cleanNodeId]) {
            editor.drawflow.drawflow.Home.data[cleanNodeId].data.text = storedTitles[key];
        }
    }
}

// –°–ª—É—Ö–∞—á –ø–æ–¥—ñ–π –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–∞–∑–≤ –≤—É–∑–ª—ñ–≤
document.addEventListener("input", function(event) {
    let textarea = event.target.closest("textarea[df-name]");
    if (textarea) {
        let nodeElement = textarea.closest(".drawflow-node");
        if (!nodeElement) return;

        let nodeId = nodeElement.getAttribute("id");
        let newText = textarea.value;

        updateNodeTitle(nodeId, newText);
        autoResizeTextarea(textarea);
    }
});

function initializeAllTextareas() {
    const textareas = document.querySelectorAll("textarea[df-name]");
    textareas.forEach(textarea => {
        autoResizeTextarea(textarea);

        textarea.addEventListener("input", function () {
            let nodeElement = textarea.closest(".drawflow-node");
            if (!nodeElement) return;
            let nodeId = nodeElement.id;
            updateNodeTitle(nodeId, textarea.value);
            autoResizeTextarea(textarea);
        });
    });
}

// –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ—ó –µ–∫—Å–ø–æ—Ä—Ç—É JSON, —â–æ–± –≤–∫–ª—é—á–∞—Ç–∏ –Ω–∞–∑–≤–∏ –¥–∏—Å—Ü–∏–ø–ª—ñ–Ω –∑ localStorage
function exportJSON() {
    // –°–ø–æ—á–∞—Ç–∫—É –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –∞–∫—Ç—É–∞–ª—å–Ω—ñ –Ω–∞–∑–≤–∏ –≤—É–∑–ª—ñ–≤ —É localStorage
    localStorage.setItem("nodeTitles", JSON.stringify(getCurrentNodeTitles()));

    let exportData = editor.export();
    exportData.schemaTitle = localStorage.getItem("schemaTitle") || "–ë–µ–∑ –Ω–∞–∑–≤–∏";

    const dataStr = JSON.stringify(exportData, null, 4);
    const blob = new Blob([dataStr], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "schema.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// –§—É–Ω–∫—Ü—ñ—è –æ—Ç—Ä–∏–º—É—î –ø–æ—Ç–æ—á–Ω—ñ –Ω–∞–∑–≤–∏ –≤—É–∑–ª—ñ–≤
function getCurrentNodeTitles() {
    let nodeTitles = {};
    document.querySelectorAll(".drawflow-node textarea[df-name]").forEach(textarea => {
        let nodeId = textarea.closest(".drawflow-node").id;
        nodeTitles[nodeId] = textarea.value;
    });
    return nodeTitles;
}

function importJSON(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (e) {
        try {
            const data = JSON.parse(e.target.result);

            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –æ–±'—î–∫—Ç –º—ñ—Å—Ç–∏—Ç—å –ø–æ—Ç—Ä—ñ–±–Ω—ñ –ø–æ–ª—è
            if (!data.drawflow || !data.drawflow.Home || !data.drawflow.Home.data) {
                throw new Error("–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª—É!");
            }

            editor.import(data);

            // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ö–µ–º–∏
            if (data.schemaTitle) {
                localStorage.setItem("schemaTitle", data.schemaTitle);
                document.querySelector(".title-input").value = data.schemaTitle;
            }

            // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –Ω–∞–∑–≤–∏ –≤—É–∑–ª—ñ–≤
            let titles = {};
            for (let key in data.drawflow.Home.data) {
                if (data.drawflow.Home.data[key]?.data?.text) {
                    titles[`node-${key}`] = data.drawflow.Home.data[key].data.text;
                }
            }
            localStorage.setItem("nodeTitles", JSON.stringify(titles));

            // –û–Ω–æ–≤–ª—é—î–º–æ —Ç–µ–∫—Å—Ç–æ–≤—ñ –ø–æ–ª—è textarea –ø—ñ—Å–ª—è —ñ–º–ø–æ—Ä—Ç—É
            setTimeout(() => {
                loadNodeTitles();             // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î –∑–Ω–∞—á–µ–Ω–Ω—è —É textarea
                initializeAllTextareas();    // –î–æ–¥–∞—î input-—Å–ª—É—Ö–∞—á—ñ —Ç–∞ –∞–≤—Ç–æ-—Ä–æ–∑–º—ñ—Ä
                saveDiagram();               // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω—É —Å—Ö–µ–º—É
            }, 200);

        } catch (error) {
            console.error("–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É JSON:", error);
            alert("–§–∞–π–ª –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–∏–π! –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ñ–æ—Ä–º–∞—Ç.");
        }
    };
    reader.readAsText(file);
}

// –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–∞–∑–≤–∏ —Å—Ö–µ–º–∏ –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ç–µ–∫—Å—Ç—É –≤ –ø–æ–ª—ñ
document.querySelector(".title-input").addEventListener("input", saveSchemaName);

  </script>
</body>
</html>